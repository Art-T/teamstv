<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>COE TV</title>

  <script src="./js/jquery-3.3.1.min.js" type="text/javascript"></script>
  <script src="./js/lodash.js" type="text/javascript"></script>
  <script src="./js/jquery.gridster.js" type="text/javascript"></script>
  <script src="./js/owl.carousel.min.js" type="text/javascript"></script>
  <script src="http://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
  <script src="./js/mootools-yui-compressed.js"></script>
  <script src="./js/clock.js" type="text/javascript"></script>
  <!-- <script src="https://weatherwidget.io/js/widget.min.js" type="text/javascript"></script> -->

  <link rel="stylesheet" type="text/css" href="./css/owl.carousel.min.css">
  <link rel="stylesheet" type="text/css" href="./css/jquery.gridster.min.css">
  <link rel="stylesheet" type="text/css" href="./css/gridster_custom.css">
  <link rel="stylesheet" type="text/css" href="./css/clock.css">
  <link rel="stylesheet" type="text/css" href="./css/newClock.css">

  <script type="text/javascript">

    var gridster;

    var serialization = [];

    // for grid testing
    // for (var h = 1; h < 7; h++) {
    //  for (var v = 1; v < 7; v++) {
    //    serialization.push({
    //      col: h, row: v, size_x: 1, size_y: 1
    //    })
    //  }
    // }

    $(function () {

      console.log(screen.width+' '+screen.height);

        gridster = $(".gridster ul").gridster({
            widget_base_dimensions: [Math.round(screen.width / 3), Math.round(screen.height / 2)],
            widget_margins: [0, 0],
            avoid_overlapped_widgets: false
        }).data('gridster').disable();

        function getBlockLayout(block) {
          switch (block) {
            case "1": return {
                        col: 1,
                        row: 1,
                        size_x: 2,
                        size_y: 1
                      };
                      break;
            case "2": return {
                        col: 1,
                        row: 1,
                        size_x: 2,
                        size_y: 2
                      };
                      break;
            case "3": return {
                        col: 3,
                        row: 1,
                        size_x: 1,
                        size_y: 1
                      };
                      break;
            case "4": return {
                        col: 3,
                        row: 2,
                        size_x: 1,
                        size_y: 1
                      };
                      break;

            case "12": return {
                        col: 1,
                        row: 1,
                        size_x: 2,
                        size_y: 2
                      };
                      break;
            case "13": return {
                        col: 1,
                        row: 1,
                        size_x: 3,
                        size_y: 1
                      };
                      break;
            case "24": return {
                        col: 1,
                        row: 2,
                        size_x: 3,
                        size_y: 1
                      };
                      break;
            case "34": return {
                        col: 3,
                        row: 1,
                        size_x: 1,
                        size_y: 2
                      };
                      break;

            case "1234": return {
                        col: 1,
                        row: 1,
                        size_x: 3,
                        size_y: 2
                      };
                      break;
          }
        }

        function placeClock(id, options) {
          var wrapper;
          var options = options || {};
          var cid = "clock_"+id;

          $.ajax({
            url: "html/clock.html",
            cache: false,
            success: function (data) {
              $('#' + id).html(data);
              
              setTimeout(function () {
                clockInit();
              }, 250);
              setTimeout(function() {
                initWeatherWidget(document,"script","weatherwidget-io-js");
              }, 750);
            }
          });
        }

        function placeRss(id, options) {
          var wrapper;
          var options = options || {};
          var cid = "rss_"+id;

          console.log('rss', options);

          var params = "";
          // params = $.param(options); TODO: need to implement initRss() to parse the params properly

          $("#"+id).html("<iframe id='"+cid+"' src='html/rss.html?"+ params +"'></iframe>");
        }

        function placeLogo(id, option) {
          if (options.src) {
            $("#"+id).html("<img src='"+options.src+"' />");
          }
        }

        function parseBlock(id, type, data) {
          console.log('parseBlock', id, type, data);

          if (type === "map") {
            placeMap(id, data);
          }
          if (type === "text" || type === "html") {
            $("#"+id).html(data);
          }
          if (type === "carousel") {
            imgs = []
            $.ajax({
                dataType: "json",
                url: data.folder,
                cache: false,
                success: function (res) {
                    imgs = res
                    placeCarousel(id, imgs, data.interval);
                }
            });
          }
          if (type === "clock") {
            placeClock(id, data);
          }
          if (type === "rss") {
            placeRss(id);
          }
          if (type === "logo") {
            placeLogo(id);
          }
        }

        function placeMap(id, options) {
          var mid = "map_"+id;
          var wrapper = '<div id="'+mid+'" style="width: 100%; height: 100%"></div>';
    
          var options = options || {};

          $("#"+id).html(wrapper);

          console.log('initMap', id, options);

          ymaps.ready(init);

          function init () {
              var myMap = new ymaps.Map(mid, {
                    center: options.center || center[59.913, 30.316564],
                    zoom: options.zoom || 12,
                    controls: []
                  });

              var trafficControl = new ymaps.control.TrafficControl({ state: {
                      providerKey: 'traffic#actual',
                      trafficShown: true
                  }});
              myMap.controls.add(trafficControl);
              trafficControl.getProvider('traffic#actual').state.set('infoLayerShown', true);

              console.log('init map', mid, options);
          }
        }

        function placeCarousel(id, pages, interval) {
          var cid = "carousel_"+id;
          var wrapper = '<div class="owl-carousel owl-theme" id="'+cid+'"></div>';

          $("#"+id).html(wrapper);

          function initCarousel(data, interval) {

            $.each(data, function (index, page) {
                $("#"+cid).append("<div><img src='"+page+"'/></div>");
            });

            $("#"+cid).owlCarousel({
                items: 1,
                loop: true,
                nav: false,
                dots: false,
                autoplay: true,
                autoplayTimeout: interval || 3000
            });

            console.log('placeCarousel', id, pages, interval);

        }

            initCarousel(pages, interval);
        }

        function clearGrid(cleanup) {
          gridster.remove_all_widgets();
          if (cleanup) {
              gridster.destroy();
              gridster = null;
              $('#grid-container ul').empty();
              // $('body').find('iframe').remove();
              // $('body').find('script').remove();

              gridster = $(".gridster ul").gridster({
                  widget_base_dimensions: [Math.round(screen.width / 3), Math.round(screen.height / 2)],
                  widget_margins: [0, 0],
                  avoid_overlapped_widgets: false
              }).data('gridster').disable();
          }
        }

        function buildGrid(elements, cleanup) {
          clearGrid(cleanup);

          var temp_elements = _.clone(elements);

          temp_elements = Gridster.sort_by_row_and_col_asc(temp_elements);

          $.each(temp_elements, function (i, element) {
            setTimeout(function () {
              gridster.add_widget('<li id="' +element.uid+'" type="' + element.type + '"></li>', element.size_x, element.size_y, element.col, element.row);
              parseBlock(element.uid, element.type, element.data);
            }, ((i+1)*100));            
          });
          console.log('build grid', elements, temp_elements);
        }

        function getData(url, func) {
          var eq = true;
          var firstLoad = true;
          var temp = [];
          var tids = "";
          var sids = "";

          $.ajax({
            dataType: "json",
            url: url,
            cache: false,
            success: function (data) {
              console.log('Get data', data);

              $.each(data, function (i, block) {
                var blockLayout = getBlockLayout(block.blocks.join(""));

                temp.push({
                  col: blockLayout.col,
                  row: blockLayout.row,
                  size_x: blockLayout.size_x,
                  size_y: blockLayout.size_y,
                  type: block.widget,
                  data: block.data,
                  uid: block.uid,
                  modified: block.last_modified
                });
              });

              _.orderBy(temp, ['uid'], ['desc']);
              _.orderBy(serialization, ['uid'], ['desc']);

              if (serialization.length == 0) {
                eq = false;
              } else if (serialization.length != temp.length) {
                eq = false;
              } else {
                // serialization.sort(function(a,b) {return (a.uid > b.uid) ? 1 : ((b.uid > a.uid) ? -1 : 0);} );
                // temp.sort(function(a,b) {return (a.uid > b.uid) ? 1 : ((b.uid > a.uid) ? -1 : 0);} );
                for (var t = 0; t < temp.length; t++) {
                  tids = tids + temp[t].modified; // temp[t].uid + 
                }

                for (var s = 0; s < serialization.length; s++) {
                  sids = sids + serialization[s].modified; // serialization[s].uid +
                }

                console.log(tids);
                console.log(sids);
                console.log(tids != sids);

                if (tids != sids) {
                  eq = false;
                }

              }

              if (!eq) {
                if (!serialization.length) firstLoad = true; else firstLoad = false;
                serialization = temp;
                buildGrid(serialization, !firstLoad);
                console.log("build data", serialization);
              }

              // Used for Telebot
              if (func) {
                func()
              }
            },
            error: function() {
              console.log("Request Error");
            }
          });
        }

        getData("events/current");
        var interval = setInterval(function () {
          getData("events/current");
        }, 30000);

        function getTelebot() {
          getData("telebot", getTelebot);
        }
        getTelebot();
    });

  </script>

</head>
<body>
    <div class="gridster ready" id="grid-container" style="width: 100%; height: 100%;">
        <ul>
        </ul>
    </div>
</body>
</html>
