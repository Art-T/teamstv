<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>COE TV</title>

  <script src="./node_modules/angular/angular.min.js"></script>
  <script src="./jquery/jquery-3.3.1.min.js" type="text/javascript"></script>
  <script src="./dsmorse-gridster.js-2808cd7/dist/jquery.gridster.js" type="text/javascript"></script>
  <script src="./node_modules/js-md5/src/md5.js" type="text/javascript"></script>
  <script src="app.js"></script>

  <link rel="stylesheet" type="text/css" href="./dsmorse-gridster.js-2808cd7/dist/jquery.gridster.min.css">

  <link rel="stylesheet" type="text/css" href="./gridster_custom.css">

  <!-- <meta http-equiv="refresh" content="30"> -->

</head>
<body ng-app="COETVApp">
  	<div ng-controller="COETVAppController">
  		<div class="gridster ready" id="grid-container">
		    <ul>
		    </ul>
		</div>
	</div>

	<script type="text/javascript">

    var gridster;

    var serialization = [];

    // for grid testing
    // for (var h = 1; h < 7; h++) {
    // 	for (var v = 1; v < 7; v++) {
    // 		serialization.push({
    // 			col: h, row: v, size_x: 1, size_y: 1
    // 		})
    // 	}
    // }

    $(function () {

        gridster = $(".gridster ul").gridster({
            widget_base_dimensions: [341, 384],
            widget_margins: [0, 0]
        }).data('gridster');

        function parseMap(map_data) {
          var map_file;
          $.get( "map.html", function( data ) {
            console.log('data', data);
             return data;
          });
        }

        function getBlockLayout(block) {
          switch (block) {
            case "1": return {
                        col: 1,
                        row: 1,
                        size_x: 2,
                        size_y: 1
                      };
                      break;
            case "2": return {
                        col: 1,
                        row: 1,
                        size_x: 2,
                        size_y: 2
                      };
                      break;
            case "3": return {
                        col: 3,
                        row: 1,
                        size_x: 1,
                        size_y: 1
                      };
                      break;
            case "4": return {
                        col: 3,
                        row: 2,
                        size_x: 1,
                        size_y: 1
                      };
                      break;

            case "12": return {
                        col: 1,
                        row: 1,
                        size_x: 2,
                        size_y: 2
                      };
                      break;
            case "13": return {
                        col: 1,
                        row: 1,
                        size_x: 3,
                        size_y: 1
                      };
                      break;
            case "24": return {
                        col: 1,
                        row: 2,
                        size_x: 3,
                        size_y: 1
                      };
                      break;
            case "34": return {
                        col: 3,
                        row: 1,
                        size_x: 1,
                        size_y: 2
                      };
                      break;

            case "1234": return {
                        col: 1,
                        row: 1,
                        size_x: 3,
                        size_y: 3
                      };
                      break;
          }
        }

        function parseBlock(id, type, data) {
          if (type === "map") {
            var params = $.param(data);
            $("#"+id).html('<iframe src="map.html' + ((data) ? '?'+params : '') + '"></iframe>');
          }
          if (type === "text" || type === "html") {
            $("#"+id).html(data);
          }
        }

        function clearGrid() {
          serialization = [];
          gridster.remove_all_widgets();
          //$("#grid-container").find("ul").html("");
          //console.log('cleared');
        }

        function buildGrid(elements) {
          clearGrid();

          elements = Gridster.sort_by_row_and_col_asc(elements);

          $.each(elements, function (i, element) {
            gridster.add_widget('<li id="' +element.md5+'" type="' + element.type + '"></li>', element.size_x, element.size_y, element.col, element.row);
            parseBlock(element.md5, element.type, element.data);
          });
          console.log('build grid');
        }

        function getData() {
          $.getJSON( "data.json", function( data ) {
            $.each(data, function (i, block) {
              var blockLayout = getBlockLayout(block.blocks.join(""));
              serialization.push({
                col: blockLayout.col, row: blockLayout.row, size_x: blockLayout.size_x, size_y: blockLayout.size_y, type: block.widget, data: block.data, md5: md5(block.widget+block.data)
              });
            });
            console.log("build data", serialization);
            buildGrid(serialization);
          });
        }

        //getData();
        // var interval = setInterval(function () {
        //   getData(); 
        // }, 10000);

        getData();
        
    });

	</script>
</body>
</html>